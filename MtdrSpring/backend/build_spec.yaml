version: 0.2
phases:
  install:
    commands:
      - echo "Installing dependencies..."
      - sudo yum install -y maven docker
  pre_build:
    commands:
      - echo "Setting up environment variables..."
      - export IMAGE_NAME=todolistapp-springboot
      - export IMAGE_VERSION=0.1
      - |
        if [ -z "$DOCKER_REGISTRY" ]; then
          echo "DOCKER_REGISTRY not set. Will get it with state_get"
          export DOCKER_REGISTRY=$(state_get DOCKER_REGISTRY)
        fi
      - |
        if [ -z "$DOCKER_REGISTRY" ]; then
          echo "Error: DOCKER_REGISTRY env variable needs to be set!"
          exit 1
        fi
      - export IMAGE=${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_VERSION}
  build:
    commands:
      - echo "Building the application with Maven..."
      - mvn clean package spring-boot:repackage
      - echo "Building Docker image..."
      - docker build -f Dockerfile -t $IMAGE .
  post_build:
    commands:
      - echo "Pushing Docker image to registry..."
      - docker push $IMAGE
      - |
        if [ $? -eq 0 ]; then
          echo "Removing local Docker image..."
          docker rmi "$IMAGE"
        fi
artifacts:
  files:
    - target/**
    - Dockerfile
cache:
  paths:
    - '/root/.m2/**/*'
