version: 0.1
component: build
timeoutInSeconds: 10000
shell: bash
failImmediatelyOnError: true

env:
  variables:
    IMAGE_NAME: "telegram-test"
    IMAGE_VERSION: "0.1"
    DOCKER_REGISTRY: "qro.ocir.io/axs2pxpd649r/reacttodo/rkihw"
    JAVA_HOME: "/usr/lib64/graalvm/graalvm22-ee-java17"
    DOCKER_USERNAME: "axs2pxpd649r/prm-123@hotmail.com"
    DOCKER_PASSWORD: "7srs5zmwRFMBj]>VBrnL"
  exportedVariables:
    - IMAGE

steps:
  - type: Command
    name: Set Environment Variables
    shell: bash
    timeoutInSeconds: 300
    command: |
      if [ -z "$DOCKER_REGISTRY" ]; then
        echo "DOCKER_REGISTRY not set. Exiting..."
        exit 1
      fi
      export IMAGE=${DOCKER_REGISTRY}/${IMAGE_NAME}:${IMAGE_VERSION}
      echo "Environment variables set: IMAGE=${IMAGE}"
      export PATH=$JAVA_HOME/bin:$PATH
      echo "PATH set to: $PATH"

  - type: Command
    name: Install Python 3.9 using yum
    shell: bash
    timeoutInSeconds: 600
    command: |
      echo "Installing dependencies..."
      yum update -y

      echo "Installing Python 3.9..."
      yum install -y python3

      echo "Verifying Python version..."
      python3 --version

  - type: Command
    name: Install Framework
    shell: bash
    timeoutInSeconds: 600
    command: |
      echo "Compiling and building application..."
      cd MtdrSpring/Pruebas
      python3 -m pip install telethon
      if [ $? -ne 0 ]; then
        echo "Build failed!"
        exit 1
      fi
      echo "Build succeeded."

  - type: Command
    name: Log Login Test Results
    shell: bash
    timeoutInSeconds: 600
    command: |
      echo "Running application and logging test results..."
      cd MtdrSpring/Pruebas
      python3 pruebas.py 

      if [ $? -ne 0 ]; then
        echo "Application run failed!"
        exit 1
      fi
      echo "Application run succeeded."

  - type: Command
    name: Log Developer Test Results
    shell: bash
    timeoutInSeconds: 600
    command: |
      echo "Running application and logging test results..."
      cd MtdrSpring/Pruebas
      python3 prueba_start_desarrollador.py 

      if [ $? -ne 0 ]; then
        echo "Log Developer Test Results failed!"
        exit 1
      fi
      echo "Log Developer Test Results succeeded."
  
  - type: Command
    name: Log Task Creation Test Results
    shell: bash
    timeoutInSeconds: 600
    command: |
      echo "Running application and logging test results..."
      cd MtdrSpring/Pruebas
      python3 prueba_creacion_tarea.py 

      if [ $? -ne 0 ]; then
        echo "Log Task Creation Test Results failed!"
        exit 1
      fi
      echo "Log Task Creation Test Results succeeded."
